<html>
<head>
<script src='http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAjpkAC9ePGem0lIq5XcMiuhR_wWLPFku8Ix9i2SXYRVK3e45q1BQUd_beF8dtzKET_EteAjPdGDwqpQ'></script>
<script src="http://openlayers.org/api/OpenLayers.js"></script>
<script type = "text/javascript">

var map, vectors, formats;


function init()
{
 var maxExtent = new OpenLayers.Bounds(-20037508, -20037508, 20037508, 20037508),
        restrictedExtent = maxExtent.clone(),
        maxResolution = 156543.0339;

    var options = {
        projection: new OpenLayers.Projection("EPSG:900913"),
        displayProjection: new OpenLayers.Projection("EPSG:4326"),
        units: "m",
        numZoomLevels: 18,
        maxResolution: maxResolution,
        maxExtent: maxExtent,
        restrictedExtent: restrictedExtent
    };

  map = new OpenLayers.Map('map', options);

  var satellite = new OpenLayers.Layer.Google("Google Satellite", {type: G_SATELLITE_MAP, sphericalMercator: true, numZoomLevels: 22});

  vectors = new OpenLayers.Layer.Vector("Vector Layer");

  var control = new OpenLayers.Control();
  OpenLayers.Util.extend(control, {draw: function () {
                        // this Handler.Box will intercept the shift-mousedown
                        // before Control.MouseDefault gets to see it
                        this.box = new OpenLayers.Handler.Box( control,
                            {"done": this.notice},
                            {keyMask: OpenLayers.Handler.MOD_SHIFT});
                        this.box.activate();

                    },

                    notice: function (bounds) {
                        var ll = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.left, bounds.bottom));
                        var ur = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.right, bounds.top));
						var ul = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.left, bounds.top));
						var lr = map.getLonLatFromPixel(new OpenLayers.Pixel(bounds.right, bounds.bottom));

                        Input(ll.lon.toFixed(4), ll.lat.toFixed(4), ur.lon.toFixed(4),ur.lat.toFixed(4),
                              ul.lon.toFixed(4), ul.lat.toFixed(4), lr.lon.toFixed(4),lr.lat.toFixed(4));
                               }
                });

  map.addControl(new OpenLayers.Control.EditingToolbar(vectors));
  map.addControl(new OpenLayers.Control.Permalink());
  map.addControl(new OpenLayers.Control.MousePosition());
  map.addLayers([satellite, vectors]);
  map.addControl(control);

  var proj = new OpenLayers.Projection("EPSG:4326");
  var point = new OpenLayers.LonLat(-84.445, 33.7991);
  map.setCenter(point.transform(proj, map.getProjectionObject()), 12);
}



function Input(bottomLeftLon, bottomLeftLat, topRightLon, topRightLat, topLeftLon, topLeftLat, bottomRightLon, bottomRightLat)
{
  var query;
  var xmlhttp;
  var lastLon = parseFloat(bottomLeftLon);
  var lastLat = parseFloat(bottomLeftLat);

  query = 'PREFIX geo: <http://www.opengis.net/ont/OGC-GeoSPARQL/1.0/> PREFIX geo-sf: <http://www.opengis.net/def/dataType/OGC-SF/1.0/> PREFIX gn: <http://www.geonames.org/ontology#> SELECT DISTINCT ?school_wkt WHERE { GRAPH <http://example.org/data> { LET (?place := "POLYGON((-84.445 33.7991, -84.445 33.7069,-84.331 33.7069,-84.331 33.7991,-84.445 33.7991))"^^geo-sf:WKTLiteral) . ?school a gn:Feature ; geo:hasGeometry ?school_geo ; gn:featureCode gn:S.SCH . ?atl_geo a geo:Geometry ; geo:asWKT ?place . ?school_geo geo:sf-within ?atl_geo .  ?school_geo geo:asWKT ?school_wkt . } }';

  if (window.XMLHttpRequest)
  {

    xmlhttp=new XMLHttpRequest();
  }

  xmlhttp.onreadystatechange=function()
  {
    if(xmlhttp.readyState == 4)
    {
      var num;
      var list = [];
	  count = 1;
	  list = JSON.parse(xmlhttp.responseText);

	  while((count - 1) < list.length)
	  {
        DeserializePoint(list[count - 1]);
        count++;
      }
    }
  }
  xmlhttp.open("GET","/map/sparql?query=" + encodeURIComponent(query),true);
  xmlhttp.send();
}



function DeserializePoint(num)
{

  var proj = new OpenLayers.Projection("EPSG:900913");
  var WKTParser = new OpenLayers.Format.WKT();

  var features = WKTParser.read(num).transform(proj, map.getProjectionObject());
    alert("FDFD");
  var bounds;

  if(features)
  {
    if(features.constructor != Array)
      features = [features];

    for(var i=0; i<features.length; ++i)
    {
      if (!bounds)
        bounds = features[i].geometry.getBounds();
      else
        bounds.extend(features[i].geometry.getBounds());


    }
    vectors.addFeatures(features);
  }
  else
    element.value = 'Bad input ' + type;




}


</script>
</head>
<body onload = "init()">

<form>
<input type="button" value="Send Query" onclick="Input()" />
</form>

<p> Press and hold the shift key, then click and drag the mouse to create a
    rectangle that will be queried for schools.  Stay within the Atlanta area.</p>

<div id="map" class="smallmap"></div>

</body>
</html>



